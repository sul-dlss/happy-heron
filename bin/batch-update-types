#!/usr/bin/env ruby
# frozen_string_literal: true

# Usage:
#   bin/batch-update-types migration_item_type_updates.csv

require_relative '../config/environment'
require 'csv'
FILE = ARGV[0]

warn "A data files was not provided" unless FILE
Rails.logger.level = :warn

CSV.foreach(FILE, headers: true) do |row|
  work = Work.find_by(druid: "druid:#{row['item_druid']}")
  unless work
    warn("unable to find #{row['item_druid']}")
    next
  end
  work_version = work.head
  work_version.work_type = row['New Work Type'].downcase
  work_version.subtype = [row['New Subtype 1'], row['New Subtype 2'], row['New Subtype 3'], row['New Subtype 4']].compact
  work_version.save || warn("Unable to save version #{work_version.id} (#{work.druid}), #{work_version.errors.full_messages}")
end
