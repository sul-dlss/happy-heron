#!/usr/bin/env ruby
# frozen_string_literal: true

# Usage:
#   bin/migrate-collections collections.jsonl

require_relative '../config/environment'

File.foreach(ARGV[0]) do |data|
  json = JSON.parse(data)
  next unless json.present?
  puts data
  collection = Collection.find_or_initialize_by(druid: json['druid'])

  creator = User.find_or_create_by!(email: "#{json.dig('creator', 'sunetid')}@stanford.edu")

  managers = json['managers'].map do |sunetid|
    User.find_or_create_by!(email: "#{sunetid.downcase}@stanford.edu")
  end
  depositors = json['depositors'].map do |sunetid|
    User.find_or_create_by!(email: "#{sunetid.downcase}@stanford.edu")
  end
  reviewers = json['reviewers'].map do |sunetid|
    User.find_or_create_by!(email: "#{sunetid.downcase}@stanford.edu")
  end

  contact_email = if URI::MailTo::EMAIL_REGEXP.match(json['contact_email'])
    json['contact_email']
  else
    warn "Invalid contact email found in #{json['druid']}"
    nil
  end

  collection.update!(
    version: json['version'],
    description: json['description'],
    contact_email: contact_email,
    access: 'world', # TODO
    creator: creator,
    name: json['name'],
    managers: managers,
    depositors: depositors,
    reviewers: reviewers
  )
  puts "collection #{collection.id}"
end
